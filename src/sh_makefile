## usenew makefile for building with sh_make

DESTDIR=/
PREFIX=${DESTDIR}usr
APPNAME=usenew
VER=3.1
install_prefix=/usr
INSTALL=/usr/bin/install
#sh_make=./sh_make_pkg

USER_RC=\${XDG_CONFIG_HOME:-\$HOME}/usenewrc
SYSTEM_RC=/etc/usenewrc

default() {
	libuse
	usenew
	restore
}

prepare() {
 mkdir -p $PREFIX/bin
}

configure() {
	for option in use_dash ENABLE_USER_RC ENABLE_SYSTEM_RC ; do
		if [ $( eval $option ) = true ] ; then 
			echo "#\\define $option" >> buildconfig
		fi
	done
}  


usenew() {
	shpp -DUSER_RC="$USER_RC" -DSYSTEM_RC="$SYSTEM_RC" -Dgit_rev=$(./../tools/git_revgen ) -Duse_ver=${VER} -Dprefix=$PREFIX usenew.sh.in -o usenew
}

libuse() {
	sh_make -f libuse/sh_makefile PREFIX=$PREFIX
}

restore() {
	shpp git_rev=$(./../tools/git_revgen ) prefix=$PREFIX restore.in -o restore
}
install()  {
	prepare
	usenew_install
	libuse_install
	restore_install
}

usenew_install() {
	$INSTALL usenew $PREFIX/bin/usenew
}

libuse_install(){
	sh_make -f libuse/sh_makefile PREFIX=../$PREFIX install
}

restore_install() {
	$INSTALL  restore $PREFIX/bin/restore
}
clean()  {
	sh  -c 'cd libuse; . $PWD/sh_makefile; clean'
	rm -rf usenew
	rm -rf restore
}

installer() {
	load_module configure
	load_module make_installer
	gen_installer > ../install.sh
}
